<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Collaborative Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <!-- Main Container -->
    <div id="app" class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold text-gray-900">ðŸ“… Collaborative Calendar</h1>
                        <div id="userDisplay" class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium hidden">
                            <span id="userEmail">Loading...</span>
                        </div>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="flex bg-gray-100 rounded-lg p-1">
                            <button id="dayViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors">Day</button>
                            <button id="weekViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors">Week</button>
                            <button id="monthViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors">Month</button>
                            <button id="yearViewBtn" class="px-3 py-1 rounded-md text-sm font-medium transition-colors">Year</button>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="bg-white border-b border-gray-200">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-12">
                    <button id="prevBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                        </svg>
                    </button>
                    <h2 id="currentPeriod" class="text-lg font-semibold text-gray-900">Loading...</h2>
                    <button id="nextBtn" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div id="calendarContainer">
                <!-- Views will be dynamically inserted here -->
            </div>
        </main>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 id="modalTitle" class="text-lg font-semibold text-gray-900">Add Event</h3>
            </div>
            <form id="eventForm" class="px-6 py-4 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Event Title</label>
                    <input type="text" id="eventTitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" id="eventDate" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Time</label>
                        <input type="time" id="eventTime" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" required>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Recurrence</label>
                    <select id="eventRecurrence" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="none">No Recurrence</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Collaborators (comma-separated emails)</label>
                    <input type="text" id="eventCollaborators" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="user@example.com, another@example.com">
                </div>
            </form>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-between">
                <button id="deleteEventBtn" class="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors hidden">Delete</button>
                <div class="flex space-x-3">
                    <button id="cancelBtn" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors">Cancel</button>
                    <button id="saveEventBtn" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Modal -->
    <div id="emailModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900">Enter Your Email</h3>
            </div>
            <div class="px-6 py-4">
                <p class="text-gray-600 mb-4">Please enter your email address to enable collaboration features.</p>
                <input type="email" id="userEmailInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="your@email.com" required>
            </div>
            <div class="px-6 py-4 bg-gray-50 rounded-b-xl flex justify-end">
                <button id="saveEmailBtn" class="px-4 py-2 bg-blue-600 text-white hover:bg-blue-700 rounded-lg transition-colors">Save</button>
            </div>
        </div>
    </div>

    <!-- Notification -->
    <div id="notification" class="fixed top-4 right-4 bg-green-600 text-white px-4 py-2 rounded-lg shadow-lg hidden z-50">
        <span id="notificationText">Success!</span>
    </div>

    <!-- Firebase Scripts -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getFirestore, collection, doc, addDoc, updateDoc, deleteDoc, onSnapshot, query, where, getDocs, setDoc } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';
        import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';

        // Global state
        let app, db, auth, currentUser = null, currentView = 'month', currentDate = new Date();
        let events = [], userProfiles = new Map();
        const appId = window.__app_id || 'default-app';

        // Initialize Firebase
        function initFirebase() {
            const config = window.__firebase_config || {
                apiKey: "demo-key",
                authDomain: "demo.firebaseapp.com",
                projectId: "demo-project",
                storageBucket: "demo.appspot.com",
                messagingSenderId: "123456789",
                appId: "demo-app-id"
            };
            
            app = initializeApp(config);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        // Authentication
        async function authenticateUser() {
            const initialToken = window.__initial_auth_token;
            
            try {
                if (initialToken) {
                    await signInWithCustomToken(auth, initialToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error('Auth error:', error);
                await signInAnonymously(auth);
            }
        }

        // User profile management
        async function ensureUserProfile(user) {
            const profileRef = doc(db, `artifacts/${appId}/public/data/userProfiles`, user.uid);
            const userEmail = localStorage.getItem('userEmail');
            
            if (!userEmail) {
                showEmailModal();
                return;
            }
            
            await setDoc(profileRef, {
                email: userEmail,
                uid: user.uid,
                createdAt: new Date()
            }, { merge: true });
            
            document.getElementById('userEmail').textContent = userEmail;
            document.getElementById('userDisplay').classList.remove('hidden');
        }

        // Load user profiles for collaboration
        async function loadUserProfiles() {
            const profilesRef = collection(db, `artifacts/${appId}/public/data/userProfiles`);
            const snapshot = await getDocs(profilesRef);
            
            userProfiles.clear();
            snapshot.forEach(doc => {
                const data = doc.data();
                userProfiles.set(data.email, data.uid);
            });
        }

        // Event management
        async function saveEvent(eventData) {
            const eventsRef = collection(db, `artifacts/${appId}/public/data/events`);
            
            // Process collaborators
            const collaboratorUids = [];
            if (eventData.collaborators) {
                const emails = eventData.collaborators.split(',').map(e => e.trim()).filter(e => e);
                for (const email of emails) {
                    const uid = userProfiles.get(email);
                    if (uid) collaboratorUids.push(uid);
                }
            }
            
            const event = {
                ...eventData,
                collaborators: collaboratorUids,
                createdBy: currentUser.uid,
                createdAt: new Date(),
                updatedAt: new Date()
            };
            
            if (eventData.id) {
                const eventRef = doc(db, `artifacts/${appId}/public/data/events`, eventData.id);
                await updateDoc(eventRef, event);
            } else {
                await addDoc(eventsRef, event);
            }
        }

        async function deleteEvent(eventId) {
            const eventRef = doc(db, `artifacts/${appId}/public/data/events`, eventId);
            await deleteDoc(eventRef);
        }

        // Real-time listeners
        function setupEventListener() {
            const eventsRef = collection(db, `artifacts/${appId}/public/data/events`);
            const q = query(eventsRef, where('collaborators', 'array-contains', currentUser.uid));
            
            onSnapshot(q, (snapshot) => {
                events = [];
                snapshot.forEach(doc => {
                    events.push({ id: doc.id, ...doc.data() });
                });
                renderCurrentView();
            });
        }

        // Utility functions
        function formatDate(date) {
            return date.toISOString().split('T')[0];
        }

        function formatTime(date) {
            return date.toTimeString().slice(0, 5);
        }

        function getWeekStart(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day;
            return new Date(d.setDate(diff));
        }

        function getMonthStart(date) {
            return new Date(date.getFullYear(), date.getMonth(), 1);
        }

        function getDaysInMonth(date) {
            return new Date(date.getFullYear(), date.getMonth() + 1, 0).getDate();
        }

        // View rendering functions
        function renderDayView() {
            const container = document.getElementById('calendarContainer');
            const dateStr = formatDate(currentDate);
            const dayEvents = events.filter(e => e.date === dateStr);
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Daily Sections -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Daily Motivation</h3>
                            <textarea class="w-full p-3 border border-gray-200 rounded-lg resize-none" rows="3" placeholder="What's your focus for today?"></textarea>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Top 3 Priorities</h3>
                            <div class="space-y-2">
                                <input type="text" class="w-full p-2 border border-gray-200 rounded-lg" placeholder="Priority 1">
                                <input type="text" class="w-full p-2 border border-gray-200 rounded-lg" placeholder="Priority 2">
                                <input type="text" class="w-full p-2 border border-gray-200 rounded-lg" placeholder="Priority 3">
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Carry-Overs</h3>
                            <textarea class="w-full p-3 border border-gray-200 rounded-lg resize-none" rows="4" placeholder="Items from yesterday..."></textarea>
                        </div>
                        
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-3">Notes</h3>
                            <textarea class="w-full p-3 border border-gray-200 rounded-lg resize-none" rows="6" placeholder="Your thoughts..."></textarea>
                        </div>
                    </div>
                    
                    <!-- Schedule -->
                    <div class="lg:col-span-2">
                        <div class="bg-white rounded-xl shadow-sm p-6">
                            <h3 class="text-lg font-semibold text-gray-900 mb-4">Schedule</h3>
                            <div class="space-y-1">
                                ${Array.from({length: 18}, (_, i) => {
                                    const hour = i + 5;
                                    const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                                    const hourEvents = dayEvents.filter(e => e.time.startsWith(hour.toString().padStart(2, '0')));
                                    
                                    return `
                                        <div class="flex items-center border-b border-gray-100 py-2">
                                            <div class="w-16 text-sm text-gray-500 font-medium">${timeStr}</div>
                                            <div class="flex-1 ml-4 min-h-[40px] cursor-pointer hover:bg-gray-50 rounded-lg p-2 transition-colors" 
                                                 onclick="openEventModal('${dateStr}', '${timeStr}')">
                                                ${hourEvents.map(event => `
                                                    <div class="bg-blue-100 text-blue-800 px-3 py-1 rounded-lg text-sm font-medium mb-1 cursor-pointer"
                                                         onclick="event.stopPropagation(); editEvent('${event.id}')">
                                                        ${event.title}
                                                    </div>
                                                `).join('') || '<span class="text-gray-400 text-sm">Click to add event</span>'}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderWeekView() {
            const container = document.getElementById('calendarContainer');
            const weekStart = getWeekStart(currentDate);
            const days = [];
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(weekStart);
                day.setDate(weekStart.getDate() + i);
                days.push(day);
            }
            
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-8 border-b border-gray-200">
                        <div class="p-4 font-semibold text-gray-900">Time</div>
                        ${days.map(day => `
                            <div class="p-4 text-center border-l border-gray-200">
                                <div class="font-semibold text-gray-900">${day.toLocaleDateString('en', {weekday: 'short'})}</div>
                                <div class="text-sm text-gray-500">${day.getDate()}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="max-h-96 overflow-y-auto scrollbar-hide">
                        ${Array.from({length: 18}, (_, i) => {
                            const hour = i + 5;
                            const timeStr = `${hour.toString().padStart(2, '0')}:00`;
                            
                            return `
                                <div class="grid grid-cols-8 border-b border-gray-100">
                                    <div class="p-3 text-sm text-gray-500 font-medium border-r border-gray-200">${timeStr}</div>
                                    ${days.map(day => {
                                        const dayStr = formatDate(day);
                                        const dayEvents = events.filter(e => e.date === dayStr && e.time.startsWith(hour.toString().padStart(2, '0')));
                                        
                                        return `
                                            <div class="p-2 border-l border-gray-200 min-h-[50px] cursor-pointer hover:bg-gray-50 transition-colors"
                                                 onclick="openEventModal('${dayStr}', '${timeStr}')">
                                                ${dayEvents.map(event => `
                                                    <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium mb-1 cursor-pointer"
                                                         onclick="event.stopPropagation(); editEvent('${event.id}')">
                                                        ${event.title}
                                                    </div>
                                                `).join('')}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderMonthView() {
            const container = document.getElementById('calendarContainer');
            const monthStart = getMonthStart(currentDate);
            const daysInMonth = getDaysInMonth(currentDate);
            const startDay = monthStart.getDay();
            
            const days = [];
            
            // Previous month days
            const prevMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 0);
            for (let i = startDay - 1; i >= 0; i--) {
                days.push({
                    date: new Date(prevMonth.getFullYear(), prevMonth.getMonth(), prevMonth.getDate() - i),
                    isCurrentMonth: false
                });
            }
            
            // Current month days
            for (let i = 1; i <= daysInMonth; i++) {
                days.push({
                    date: new Date(currentDate.getFullYear(), currentDate.getMonth(), i),
                    isCurrentMonth: true
                });
            }
            
            // Next month days
            const remainingDays = 42 - days.length;
            for (let i = 1; i <= remainingDays; i++) {
                days.push({
                    date: new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, i),
                    isCurrentMonth: false
                });
            }
            
            container.innerHTML = `
                <div class="bg-white rounded-xl shadow-sm overflow-hidden">
                    <div class="grid grid-cols-7 border-b border-gray-200">
                        ${['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => `
                            <div class="p-4 text-center font-semibold text-gray-900 border-r border-gray-200 last:border-r-0">${day}</div>
                        `).join('')}
                    </div>
                    <div class="grid grid-cols-7">
                        ${days.map(({ date, isCurrentMonth }) => {
                            const dayStr = formatDate(date);
                            const dayEvents = events.filter(e => e.date === dayStr);
                            const isToday = dayStr === formatDate(new Date());
                            
                            return `
                                <div class="min-h-[120px] p-2 border-r border-b border-gray-200 last:border-r-0 cursor-pointer hover:bg-gray-50 transition-colors ${!isCurrentMonth ? 'bg-gray-50 text-gray-400' : ''}"
                                     onclick="goToDay('${dayStr}')">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="text-sm font-medium ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : ''}">${date.getDate()}</span>
                                        ${dayEvents.length > 0 ? `<div class="w-2 h-2 bg-blue-600 rounded-full"></div>` : ''}
                                    </div>
                                    <div class="space-y-1">
                                        ${dayEvents.slice(0, 3).map(event => `
                                            <div class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-xs font-medium truncate cursor-pointer"
                                                 onclick="event.stopPropagation(); editEvent('${event.id}')">
                                                ${event.title}
                                            </div>
                                        `).join('')}
                                        ${dayEvents.length > 3 ? `<div class="text-xs text-gray-500">+${dayEvents.length - 3} more</div>` : ''}
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderYearView() {
            const container = document.getElementById('calendarContainer');
            const year = currentDate.getFullYear();
            
            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${Array.from({length: 12}, (_, monthIndex) => {
                        const monthDate = new Date(year, monthIndex, 1);
                        const monthName = monthDate.toLocaleDateString('en', { month: 'long' });
                        const daysInMonth = getDaysInMonth(monthDate);
                        const startDay = monthDate.getDay();
                        const monthEvents = events.filter(e => {
                            const eventDate = new Date(e.date);
                            return eventDate.getFullYear() === year && eventDate.getMonth() === monthIndex;
                        });
                        
                        return `
                            <div class="bg-white rounded-xl shadow-sm p-4 cursor-pointer hover:shadow-md transition-shadow"
                                 onclick="goToMonth(${monthIndex})">
                                <h3 class="text-lg font-semibold text-gray-900 mb-3 text-center">${monthName}</h3>
                                <div class="grid grid-cols-7 gap-1 text-xs">
                                    ${['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(day => `
                                        <div class="text-center font-medium text-gray-500 p-1">${day}</div>
                                    `).join('')}
                                    ${Array.from({length: startDay}, () => '<div class="p-1"></div>').join('')}
                                    ${Array.from({length: daysInMonth}, (_, dayIndex) => {
                                        const day = dayIndex + 1;
                                        const dayStr = formatDate(new Date(year, monthIndex, day));
                                        const hasEvents = monthEvents.some(e => e.date === dayStr);
                                        
                                        return `
                                            <div class="text-center p-1 hover:bg-gray-100 rounded ${hasEvents ? 'bg-blue-100 text-blue-800 font-medium' : ''}">
                                                ${day}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                <div class="mt-3 text-center">
                                    <span class="text-sm text-gray-600">${monthEvents.length} events</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // Navigation functions
        function updatePeriodDisplay() {
            const periodElement = document.getElementById('currentPeriod');
            
            switch (currentView) {
                case 'day':
                    periodElement.textContent = currentDate.toLocaleDateString('en', { 
                        weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
                    });
                    break;
                case 'week':
                    const weekStart = getWeekStart(currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekStart.getDate() + 6);
                    periodElement.textContent = `${weekStart.toLocaleDateString('en', { month: 'short', day: 'numeric' })} - ${weekEnd.toLocaleDateString('en', { month: 'short', day: 'numeric', year: 'numeric' })}`;
                    break;
                case 'month':
                    periodElement.textContent = currentDate.toLocaleDateString('en', { year: 'numeric', month: 'long' });
                    break;
                case 'year':
                    periodElement.textContent = currentDate.getFullYear().toString();
                    break;
            }
        }

        function navigatePrevious() {
            switch (currentView) {
                case 'day':
                    currentDate.setDate(currentDate.getDate() - 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() - 7);
                    break;
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    break;
                case 'year':
                    currentDate.setFullYear(currentDate.getFullYear() - 1);
                    break;
            }
            updatePeriodDisplay();
            renderCurrentView();
        }

        function navigateNext() {
            switch (currentView) {
                case 'day':
                    currentDate.setDate(currentDate.getDate() + 1);
                    break;
                case 'week':
                    currentDate.setDate(currentDate.getDate() + 7);
                    break;
                case 'month':
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    break;
                case 'year':
                    currentDate.setFullYear(currentDate.getFullYear() + 1);
                    break;
            }
            updatePeriodDisplay();
            renderCurrentView();
        }

        function setActiveViewButton() {
            const buttons = ['dayViewBtn', 'weekViewBtn', 'monthViewBtn', 'yearViewBtn'];
            buttons.forEach(id => {
                const btn = document.getElementById(id);
                btn.classList.remove('bg-blue-600', 'text-white');
                btn.classList.add('text-gray-600', 'hover:text-gray-900');
            });
            
            const activeBtn = document.getElementById(`${currentView}ViewBtn`);
            activeBtn.classList.add('bg-blue-600', 'text-white');
            activeBtn.classList.remove('text-gray-600', 'hover:text-gray-900');
        }

        function renderCurrentView() {
            switch (currentView) {
                case 'day': renderDayView(); break;
                case 'week': renderWeekView(); break;
                case 'month': renderMonthView(); break;
                case 'year': renderYearView(); break;
            }
            updatePeriodDisplay();
            setActiveViewButton();
        }

        // Modal functions
        window.openEventModal = function(date, time, eventId = null) {
            const modal = document.getElementById('eventModal');
            const title = document.getElementById('modalTitle');
            const form = document.getElementById('eventForm');
            const deleteBtn = document.getElementById('deleteEventBtn');
            
            if (eventId) {
                const event = events.find(e => e.id === eventId);
                title.textContent = 'Edit Event';
                form.elements.eventTitle.value = event.title;
                form.elements.eventDate.value = event.date;
                form.elements.eventTime.value = event.time;
                form.elements.eventRecurrence.value = event.recurrence || 'none';
                form.elements.eventCollaborators.value = event.collaboratorEmails || '';
                form.dataset.eventId = eventId;
                deleteBtn.classList.remove('hidden');
            } else {
                title.textContent = 'Add Event';
                form.reset();
                form.elements.eventDate.value = date;
                form.elements.eventTime.value = time;
                form.dataset.eventId = '';
                deleteBtn.classList.add('hidden');
            }
            
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        window.editEvent = function(eventId) {
            const event = events.find(e => e.id === eventId);
            openEventModal(event.date, event.time, eventId);
        };

        window.goToDay = function(dateStr) {
            currentDate = new Date(dateStr);
            currentView = 'day';
            renderCurrentView();
        };

        window.goToMonth = function(monthIndex) {
            currentDate.setMonth(monthIndex);
            currentView = 'month';
            renderCurrentView();
        };

        function showNotification(message) {
            const notification = document.getElementById('notification');
            document.getElementById('notificationText').textContent = message;
            notification.classList.remove('hidden');
            setTimeout(() => notification.classList.add('hidden'), 3000);
        }

        function showEmailModal() {
            const modal = document.getElementById('emailModal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', async () => {
            initFirebase();
            await authenticateUser();
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await ensureUserProfile(user);
                    await loadUserProfiles();
                    setupEventListener();
                    renderCurrentView();
                }
            });
            
            // View buttons
            document.getElementById('dayViewBtn').addEventListener('click', () => {
                currentView = 'day';
                renderCurrentView();
            });
            
            document.getElementById('weekViewBtn').addEventListener('click', () => {
                currentView = 'week';
                renderCurrentView();
            });
            
            document.getElementById('monthViewBtn').addEventListener('click', () => {
                currentView = 'month';
                renderCurrentView();
            });
            
            document.getElementById('yearViewBtn').addEventListener('click', () => {
                currentView = 'year';
                renderCurrentView();
            });
            
            // Navigation buttons
            document.getElementById('prevBtn').addEventListener('click', navigatePrevious);
            document.getElementById('nextBtn').addEventListener('click', navigateNext);
            
            // Modal handlers
            document.getElementById('cancelBtn').addEventListener('click', () => {
                document.getElementById('eventModal').classList.add('hidden');
                document.getElementById('eventModal').classList.remove('flex');
            });
            
            document.getElementById('saveEventBtn').addEventListener('click', async () => {
                const form = document.getElementById('eventForm');
                const eventData = {
                    title: form.elements.eventTitle.value,
                    date: form.elements.eventDate.value,
                    time: form.elements.eventTime.value,
                    recurrence: form.elements.eventRecurrence.value,
                    collaborators: form.elements.eventCollaborators.value,
                    id: form.dataset.eventId || null
                };
                
                await saveEvent(eventData);
                showNotification(eventData.id ? 'Event updated!' : 'Event created!');
                
                document.getElementById('eventModal').classList.add('hidden');
                document.getElementById('eventModal').classList.remove('flex');
            });
            
            document.getElementById('deleteEventBtn').addEventListener('click', async () => {
                const form = document.getElementById('eventForm');
                const eventId = form.dataset.eventId;
                
                if (eventId) {
                    await deleteEvent(eventId);
                    showNotification('Event deleted!');
                    
                    document.getElementById('eventModal').classList.add('hidden');
                    document.getElementById('eventModal').classList.remove('flex');
                }
            });
            
            document.getElementById('saveEmailBtn').addEventListener('click', async () => {
                const email = document.getElementById('userEmailInput').value;
                if (email) {
                    localStorage.setItem('userEmail', email);
                    await ensureUserProfile(currentUser);
                    await loadUserProfiles();
                    
                    document.getElementById('emailModal').classList.add('hidden');
                    document.getElementById('emailModal').classList.remove('flex');
                }
            });
            
            // Close modals on backdrop click
            document.getElementById('eventModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.add('hidden');
                    e.currentTarget.classList.remove('flex');
                }
            });
            
            document.getElementById('emailModal').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) {
                    e.currentTarget.classList.add('hidden');
                    e.currentTarget.classList.remove('flex');
                }
            });
        });
    </script>
</body>
</html>